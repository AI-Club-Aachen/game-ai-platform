name: Pull Request Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/**'
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  PYTHONPATH: backend

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python and uv
        uses: ./.github/actions/python-uv
        with:
          python-version: '3.13'
          working-directory: 'backend'

      - name: Run code quality checks
        working-directory: backend
        run: |
          # Run linting
          echo "Running linter..."
          uv run lint
          LINT_EXIT_CODE=$?

          # Run format check
          echo -e "\nChecking code formatting..."
          uv run format
          FORMAT_EXIT_CODE=$?

          # Run type check
          echo -e "\nRunning type checks..."
          uv run type-check
          TYPE_EXIT_CODE=$?

          # Add results to summary
          echo "## ðŸ” Code Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $LINT_EXIT_CODE -eq 0 ]; then
            echo "âœ… **Linting**: All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Linting**: Failed. Run \`uv run lint\` to check locally." >> $GITHUB_STEP_SUMMARY
          fi

          if [ $FORMAT_EXIT_CODE -eq 0 ]; then
            echo "âœ… **Formatting**: All files properly formatted!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Formatting**: Failed. Run \`uv run format\` to auto-format." >> $GITHUB_STEP_SUMMARY
          fi

          if [ $TYPE_EXIT_CODE -eq 0 ]; then
            echo "âœ… **Type Check**: All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Type Check**: Failed. Run \`uv run type-check\` to check locally." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Run linting" >> $GITHUB_STEP_SUMMARY
          echo "uv run lint" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Auto-format code" >> $GITHUB_STEP_SUMMARY
          echo "uv run format" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run type checks" >> $GITHUB_STEP_SUMMARY
          echo "uv run type-check" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Exit with error if any check failed
          if [ $LINT_EXIT_CODE -ne 0 ] || [ $FORMAT_EXIT_CODE -ne 0 ] || [ $TYPE_EXIT_CODE -ne 0 ]; then
            exit 1
          fi
