name: Playwright Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: Install dependencies
      working-directory: ./frontend
      run: pnpm install --frozen-lockfile

    - name: Install Playwright Browsers
      working-directory: ./frontend
      run: pnpm exec playwright install --with-deps chromium

    # Verify docker installation
    - name: Check Docker
      run: docker --version && docker compose version

    - name: Setup Backend Environment
      working-directory: ./backend
      run: |
        cat <<EOF > .env
        # Environment
        ENVIRONMENT=development
        
        # Database Connection
        DATABASE_URL=postgresql://postgres:postgres@db:5432/gameai
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=postgres
        POSTGRES_DB=gameai
        POSTGRES_PORT=5432
        
        # Backend Port
        BACKEND_PORT=8000
        
        # Security
        JWT_SECRET_KEY=mock-secret-key-for-ci-tests-only-do-not-use-in-prod
        JWT_ALGORITHM=HS256
        JWT_ACCESS_TOKEN_EXPIRE_HOURS=24
        ALLOW_ORIGINS=["http://localhost:3000"]
        FRONTEND_URL=http://localhost:3000
        
        # SMTP (Mock)
        SMTP_HOST=smtp.gmail.com
        SMTP_PORT=587
        SMTP_USERNAME=mock@example.com
        SMTP_PASSWORD=mockpassword
        SMTP_FROM_ADDRESS=mock@example.com
        SMTP_FROM_NAME="Game AI Platform"
        SMTP_USE_TLS=true
        
        # Token expiry
        EMAIL_VERIFICATION_TOKEN_EXPIRE_HOURS=24
        PASSWORD_RESET_TOKEN_EXPIRE_MINUTES=60
        
        # Application
        API_V1_PREFIX=/api/v1
        PROJECT_NAME="Game AI Platform"
        EOF

    - name: Start Backend Services
      working-directory: ./backend
      run: docker compose -f docker-compose.ci.yml up -d

    - name: Wait for Backend
      run: |
        echo "Waiting for backend health check..."
        timeout 60s bash -c 'until curl -s http://localhost:8000/api/v1/health; do sleep 5; done'

    - name: Run Playwright tests
      working-directory: ./frontend
      run: |
        pnpm run dev --port 3000 --host &
        echo "Waiting for frontend to be ready..."
        npx wait-on tcp:3000
        pnpm run test:e2e
      env:
        CI: true
        CI_COMPOSE_FILE: ../backend/docker-compose.ci.yml

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 30
